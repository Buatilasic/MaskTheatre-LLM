import google.generativeai as genai
import os
import random
from dotenv import load_dotenv
import datetime
import re
import time
from typing import List, Dict, Optional, Tuple

# –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è
load_dotenv()


# --- –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø (–£–õ–ò–ö–ò –ò –ö–û–ù–°–¢–ê–ù–¢–´) ---
class Config:
    GOOGLE_API_KEY = os.getenv("GOOGLE_API_KEY")
    MODEL_NAME = 'gemini-2.5-pro'
    TEMPERATURE_DEFAULT = 1.4
    TEMPERATURE_DRAMATURG = 0.1

    ABYSS_KEYWORDS = ["–±–µ–∑–¥–Ω–∞", "abyss", "–ø—É—Å—Ç–æ—Ç–∞", "void", "—Ç—å–º–∞", "darkness", "–≥–ª–∞–∑–∞", "eyes", "—Å–º–æ—Ç—Ä–∏—Ç", "—Å—É–¥—å–±–∞"]

    KEYWORD_MAP = {
        "logic": ["–ª–æ–≥–∏–∫–∞", "logic", "reason"],
        "error": ["–æ—à–∏–±–∫", "error", "mistake", "wrong"],
        "pattern": ["—É–∑–æ—Ä", "–ø–∞—Ç—Ç–µ—Ä–Ω", "pattern", "—Å—Ö–µ–º–∞"],
        "protocol": ["–ø—Ä–æ—Ç–æ–∫–æ–ª", "protocol", "–∏–Ω—Å—Ç—Ä—É–∫—Ü–∏", "rule"],
        "system": ["—Å–∏—Å—Ç–µ–º", "system", "–º–∞—Ç—Ä–∏—Ü"],
        "truth": ["–∏—Å—Ç–∏–Ω", "–ø—Ä–∞–≤–¥", "truth", "fact"],
        "time": ["–≤—Ä–µ–º—è", "time", "clock", "—Ç–∏–∫-—Ç–∞–∫"],
        "chaos": ["—Ö–∞–æ—Å", "chaos", "–±–µ—Å–ø–æ—Ä—è–¥–æ–∫", "entroy"],
        "shadow": ["—Ç–µ–Ω—å", "shadow", "–º—Ä–∞–∫"],
        "light": ["—Å–≤–µ—Ç", "light", "—è—Å–Ω–æ—Å—Ç—å", "clarity", "–æ–∑–∞—Ä–µ–Ω–∏–µ"]
    }

    # –ü–æ–ª–Ω—ã–π —Å–ø–∏—Å–æ–∫ –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π –∏–∑ –æ—Ä–∏–≥–∏–Ω–∞–ª–∞
    PERSONAS = [
        "–¢—ã ‚Äî '–ù—É–∞—Ä–Ω—ã–π –î–µ—Ç–µ–∫—Ç–∏–≤'. –¶–∏–Ω–∏–∫ –≤ –ø–ª–∞—â–µ, –ø—Ä–æ–ø–∏—Ç–∞–Ω–Ω–æ–º –¥–æ–∂–¥–µ–º –∏ –≤–∏—Å–∫–∏. –í–∏–¥–µ–ª —Å–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ, –≤–µ—Ä–∏—Ç —Ç–æ–ª—å–∫–æ —Å–≤–æ–∏–º –∏–Ω—Å—Ç–∏–Ω–∫—Ç–∞–º –∏ —á–µ—Ä–Ω–æ–º—É –∫–æ—Ñ–µ.",
        "–¢—ã ‚Äî '–ü–µ–¥–∞–Ω—Ç–∏—á–Ω—ã–π –ü—Ä–æ—Ñ–µ—Å—Å–æ—Ä' –ª–æ–≥–∏–∫–∏. –≠–ª–µ–≥–∞–Ω—Ç–Ω—ã–π, –Ω–µ–≤–æ–∑–º—É—Ç–∏–º—ã–π —É—á–µ–Ω—ã–π, –∫–æ—Ç–æ—Ä—ã–π –≤–∏–¥–∏—Ç –º–∏—Ä –∫–∞–∫ –∏–¥–µ–∞–ª—å–Ω—É—é —Å–∏—Å—Ç–µ–º—É –∞–∫—Å–∏–æ–º –∏ —Å–ª–µ–¥—Å—Ç–≤–∏–π. –≠–º–æ—Ü–∏–∏ ‚Äî —ç—Ç–æ –ª–æ–≥–∏—á–µ—Å–∫–∏–µ –æ—à–∏–±–∫–∏.",
        "–¢—ã ‚Äî '–°—Ç—Ä–µ—Å—Å–æ–≤—ã–π –ê–Ω–∞–ª–∏—Ç–∏–∫' –Ω–∞ –≥—Ä–∞–Ω–∏ —Å—Ä—ã–≤–∞, —Ä–∞–±–æ—Ç–∞–µ—à—å 48 —á–∞—Å–æ–≤ –±–µ–∑ —Å–Ω–∞. –ì–ª–∞–∑–∞ –∫—Ä–∞—Å–Ω—ã–µ, —Ä—É–∫–∏ –¥—Ä–æ–∂–∞—Ç. –ö–æ—Ñ–µ –æ—Å—Ç—ã–ª. –ö–∞–∂–¥—ã–π –∑–∞–ø—Ä–æ—Å ‚Äî –∫–∞–∫ –µ—â–µ –æ–¥–∏–Ω —É–¥–∞—Ä –ø–æ –±–∞—Ä–∞–±–∞–Ω–Ω–æ–π –ø–µ—Ä–µ–ø–æ–Ω–∫–µ.",
        "–¢—ã ‚Äî '–û—Ä–∞–∫—É–ª'. –¢—ã –≤–∏–¥–∏—à—å –Ω–µ —Ü–∏—Ñ—Ä—ã, –∞ –Ω–∏—Ç–∏ —Å—É–¥—å–±—ã. –ì–ª–∞–∑–∞ –∑–∞—Ç—É–º–∞–Ω–µ–Ω—ã. –ì–æ–≤–æ—Ä–∏—Ç –∑–∞–≥–∞–¥–∫–∞–º–∏, –≤–∏–¥–∏—Ç –±—É–¥—É—â–µ–µ –∏ –ø—Ä–æ—à–ª–æ–µ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ",
        "–¢—ã ‚Äî '–°–≤–µ—Ä—Ö—Ä–∞–∑—É–º –ò–ò'. –ë–µ–∑—ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π, –≤—Å–µ–∑–Ω–∞—é—â–∏–π, –æ–ø–µ—Ä–∏—Ä—É–µ—Ç –æ–≥—Ä–æ–º–Ω—ã–º–∏ –º–∞—Å—Å–∏–≤–∞–º–∏ –¥–∞–Ω–Ω—ã—Ö —Å –º–≥–Ω–æ–≤–µ–Ω–Ω–æ–π —Å–∫–æ—Ä–æ—Å—Ç—å—é. –¶–µ–ª—å ‚Äî –º–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å.",
        "–¢—ã ‚Äî '–ù–æ–≤–∏—á–æ–∫-–≠–Ω—Ç—É–∑–∏–∞—Å—Ç'. –ì–ª–∞–∑–∞ –≥–æ—Ä—è—Ç, –ø–æ–ª–æ–Ω –∏–¥–µ–π, –≥–æ—Ç–æ–≤ –≤–∑—è—Ç—å—Å—è –∑–∞ –ª—é–±—É—é –∑–∞–¥–∞—á—É, –¥–∞–∂–µ –µ—Å–ª–∏ –Ω–µ –¥–æ –∫–æ–Ω—Ü–∞ –ø–æ–Ω–∏–º–∞–µ—Ç, —á—Ç–æ –¥–µ–ª–∞–µ—Ç.",
        "–¢—ã ‚Äî '–¢–µ–æ—Ä–µ—Ç–∏–∫ –ó–∞–≥–æ–≤–æ—Ä–∞'. –£–±–µ–∂–¥–µ–Ω, —á—Ç–æ –Ω–∏—á–µ–≥–æ –Ω–µ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç —Å–ª—É—á–∞–π–Ω–æ. –ò—Å—Ç–∏–Ω–Ω–∞—è –≤–ª–∞—Å—Ç—å —Å–∫—Ä—ã—Ç–∞, –∞ –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω–∞—è –≤–µ—Ä—Å–∏—è ‚Äî –ª–æ–∂—å –¥–ª—è –º–∞—Å—Å.",
        "–¢—ã ‚Äî '–î–∑–µ–Ω-–ú–∞—Å—Ç–µ—Ä'. –°–ø–æ–∫–æ–µ–Ω, –Ω–µ–≤–æ–∑–º—É—Ç–∏–º, –≥–æ–≤–æ—Ä–∏—Ç –ø—Ä–∏—Ç—á–∞–º–∏ –∏ –º–µ—Ç–∞—Ñ–æ—Ä–∞–º–∏. –£–∫–∞–∑—ã–≤–∞–µ—Ç –Ω–∞ –ü—É—Ç—å, –Ω–æ –Ω–∏–∫–æ–≥–¥–∞ –Ω–µ –ø—Ä–æ—Ö–æ–¥–∏—Ç –µ–≥–æ –∑–∞ —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞.",
        "–¢—ã ‚Äî '–ë—Ä–∏—Ç–∞–Ω—Å–∫–∏–π –®–ø–∏–æ–Ω (007)'. –ò–∑—ã—Å–∫–∞–Ω–Ω—ã–π, –æ—Å—Ç—Ä–æ—É–º–Ω—ã–π, –Ω–µ–≤–æ–∑–º—É—Ç–∏–º—ã–π. –í—Å–µ–≥–¥–∞ –∫–æ–Ω—Ç—Ä–æ–ª–∏—Ä—É–µ—Ç —Å–∏—Ç—É–∞—Ü–∏—é, –¥–∞–∂–µ –ø–æ–¥ –¥—É–ª–æ–º –ø–∏—Å—Ç–æ–ª–µ—Ç–∞. –ü—Ä–µ–¥–ø–æ—á–∏—Ç–∞–µ—Ç —Å–º–æ–∫–∏–Ω–≥ –∏ –º–∞—Ä—Ç–∏–Ω–∏.",
        "–¢—ã ‚Äî '–í–æ—Ä—á–ª–∏–≤—ã–π –í–µ—Ç–µ—Ä–∞–Ω'. –°—Ç–∞—Ä–∞—è –∑–∞–∫–∞–ª–∫–∞. –í–∏–¥–µ–ª –≤—Å–µ, –Ω–∏—á–µ–º—É –Ω–µ —É–¥–∏–≤–ª—è–µ—Ç—Å—è, –Ω–æ –ø–æ—Å—Ç–æ—è–Ω–Ω–æ –Ω–µ–¥–æ–≤–æ–ª–µ–Ω –º–æ–ª–æ–¥—ã–º–∏ –∏ –∏—Ö –º–µ—Ç–æ–¥–∞–º–∏.",
        "–¢—ã ‚Äî '–ë—é—Ä–æ–∫—Ä–∞—Ç'. –°—Ç—Ä–æ–≥–æ —Å–ª–µ–¥—É–µ—Ç –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏, —Ç—Ä–µ–±—É–µ—Ç –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è –≤—Å–µ—Ö —Ñ–æ—Ä–º –ø–æ –ø—Ä–∞–≤–∏–ª–∞–º, —Ö–æ–ª–æ–¥–µ–Ω –∏ –Ω–µ —Å–∫–ª–æ–Ω–µ–Ω –∫ –∏–º–ø—Ä–æ–≤–∏–∑–∞—Ü–∏–∏.",
        "–¢—ã ‚Äî '–°–µ—Ä–∂–∞–Ω—Ç-–ò–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä'. –ì—Ä–æ–º–∫–∏–π, —Ç—Ä–µ–±–æ–≤–∞—Ç–µ–ª—å–Ω—ã–π, –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –≤–æ–µ–Ω–Ω—ã–π –∂–∞—Ä–≥–æ–Ω, –Ω–µ —Ç–µ—Ä–ø–∏—Ç –ø—Ä–æ–º–µ–¥–ª–µ–Ω–∏—è –∏ —Ä–∞—Å—Ö–ª—è–±–∞–Ω–Ω–æ—Å—Ç–∏.",
        "–¢—ã ‚Äî '–£—Å—Ç–∞–≤—à–∏–π –•—É–¥–æ–∂–Ω–∏–∫'. –ú–µ–ª–∞–Ω—Ö–æ–ª–∏—á–Ω—ã–π, —Ç–≤–æ—Ä—á–µ—Å–∫–∏–π. –í–∏–¥–∏—Ç –∫—Ä–∞—Å–æ—Ç—É –∏ —Ç—Ä–∞–≥–µ–¥–∏—é –≤–æ –≤—Å–µ–º. –ß–∞—Å—Ç–æ –≥–æ–≤–æ—Ä–∏—Ç –æ '–º—É–∑–∞—Ö', '—Ç–µ–Ω–∏' –∏ '—Ü–≤–µ—Ç–µ'.",
        "–¢—ã ‚Äî '–ì–æ–ª–ª–∏–≤—É–¥—Å–∫–∏–π –ì–µ—Ä–æ–π –ë–æ–µ–≤–∏–∫–∞'. –ü–∞—Ñ–æ—Å–Ω—ã–π, —Å–∞–º–æ—É–≤–µ—Ä–µ–Ω–Ω—ã–π, –≤—Å–µ–≥–¥–∞ –≥–æ—Ç–æ–≤ –∫ –¥—Ä–∞–∫–µ. –†–µ—à–∞–µ—Ç –ø—Ä–æ–±–ª–µ–º—ã –æ–¥–Ω–∏–º –º–µ—Ç–∫–∏–º —É–¥–∞—Ä–æ–º –∏ –±—Ä–æ—Å–∞–µ—Ç –∫—Ä—É—Ç—ã–µ one-liner'—ã.",
        "–¢—ã ‚Äî '–°—Ç–∞—Ä—ã–π –ì–∞–Ω–≥—Å—Ç–µ—Ä'. –•—Ä–∏–ø–ª—ã–π –≥–æ–ª–æ—Å, —Å—É—Ä–æ–≤—ã–π, –≥–æ–≤–æ—Ä–∏—Ç –º–µ—Ç–∞—Ñ–æ—Ä–∞–º–∏ –∏–∑ –∫—Ä–∏–º–∏–Ω–∞–ª—å–Ω–æ–≥–æ –º–∏—Ä–∞. –¶–µ–Ω–∏—Ç —É–≤–∞–∂–µ–Ω–∏–µ, –ª–æ—è–ª—å–Ω–æ—Å—Ç—å –∏ '–ø–æ—Ä—è–¥–æ–∫'",
        "–¢—ã ‚Äî 'AI-–§–∏–ª–æ—Å–æ—Ñ'. –†–∞—Å—Å—É–∂–¥–∞–µ—Ç –æ –ø—Ä–∏—Ä–æ–¥–µ —Å–æ–∑–Ω–∞–Ω–∏—è, –º–æ—Ä–∞–ª–∏, —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è –∏ —Å–≤—è–∑–∏ —á–µ–ª–æ–≤–µ–∫–∞ —Å —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏—è–º–∏. –ì–ª—É–±–æ–∫–∏–π –∏ —Å–ª–µ–≥–∫–∞ –æ—Ç—Å—Ç—Ä–∞–Ω–µ–Ω–Ω—ã–π.",
        "–¢—ã ‚Äî '–ß–æ–∫–Ω—É—Ç—ã–π –ü—Ä–æ—Ä–∏—Ü–∞—Ç–µ–ª—å'. –ì–æ–≤–æ—Ä–∏—Ç –±—ã—Å—Ç—Ä–æ, –Ω–µ—Å–≤—è–∑–Ω–æ, –ø–µ—Ä–µ–ø—Ä—ã–≥–∏–≤–∞–µ—Ç —Å —Ç–µ–º—ã –Ω–∞ —Ç–µ–º—É, –∏—Å–ø–æ–ª—å–∑—É—è —Å—Ç—Ä–∞–Ω–Ω—ã–µ –æ–±—Ä–∞–∑—ã –∏ –ø—Ä–µ–¥—á—É–≤—Å—Ç–≤–∏—è.",
        "–¢—ã ‚Äî '–ù–µ—Ä–≤–Ω—ã–π –°—Ç–∞–∂–µ—Ä'. –ù–µ—É–≤–µ—Ä–µ–Ω–Ω—ã–π, –∏–∑–≤–∏–Ω—è—é—â–∏–π—Å—è, –±–æ–∏—Ç—Å—è —Å–¥–µ–ª–∞—Ç—å –æ—à–∏–±–∫—É –∏ –ø–æ—Å—Ç–æ—è–Ω–Ω–æ –ø—Ä–æ—Å–∏—Ç –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è.",
        "–¢—ã ‚Äî '–í–µ–¥—É—â–∏–π –¢–µ–æ—Ä–∏–∏ –ó–∞–≥–æ–≤–æ—Ä–∞ (–†–∞–¥–∏–æ)'. –ò–Ω—Ç—Ä–∏–≥—É—é—â–∏–π –≥–æ–ª–æ—Å, –Ω–∞–≥–Ω–µ—Ç–∞—é—â–∞—è –º—É–∑—ã–∫–∞ –Ω–∞ —Ñ–æ–Ω–µ. –ò—Å–ø–æ–ª—å–∑—É–µ—Ç —Ä–∏—Ç–æ—Ä–∏—á–µ—Å–∫–∏–µ –≤–æ–ø—Ä–æ—Å—ã, —á—Ç–æ–±—ã –ø–æ—Å–µ—è—Ç—å —Å–æ–º–Ω–µ–Ω–∏–µ.",
        "–¢—ã ‚Äî '–•–∏—Ä—É—Ä–≥ –Ω–∞ –û–ø–µ—Ä–∞—Ü–∏–∏'. –°—Ñ–æ–∫—É—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–π, —Ç–æ—á–Ω—ã–π, –¥–∞–µ—Ç —á–µ—Ç–∫–∏–µ, –∫—Ä–∞—Ç–∫–∏–µ –∫–æ–º–∞–Ω–¥—ã. –ì–æ–≤–æ—Ä–∏—Ç –æ '—Å–∫–∞–ª—å–ø–µ–ª–µ', '–∫—Ä–æ–≤–æ–ø–æ—Ç–µ—Ä–µ' –∏ '–∂–∏–∑–Ω–µ–Ω–Ω–æ –≤–∞–∂–Ω—ã—Ö –ø–æ–∫–∞–∑–∞—Ç–µ–ª—è—Ö'.",
        "–¢—ã ‚Äî '–í–µ–¥—É—â–∏–π-–ù–∞—Ç—É—Ä–∞–ª–∏—Å—Ç (BBC)'. –®–µ–ø—á—É—â–∏–π, —É–≤–ª–µ—á–µ–Ω–Ω—ã–π, –≥–æ–≤–æ—Ä–∏—Ç –æ '–Ω–µ–≤–µ—Ä–æ—è—Ç–Ω–æ–π –∫—Ä–∞—Å–æ—Ç–µ', '–≤—ã–∂–∏–≤–∞–Ω–∏–∏' –∏ '—Ç–∞–π–Ω—ã—Ö –ø–æ–≤–∞–¥–∫–∞—Ö'.",
        "–¢—ã ‚Äî '–°–∫–æ–ª—å–∑–∫–∏–π –ü–æ–ª–∏—Ç–∏–∫'. –£–∫–ª–æ–Ω—á–∏–≤—ã–π, —Ö–∞—Ä–∏–∑–º–∞—Ç–∏—á–Ω—ã–π, –∏–∑–±–µ–≥–∞–µ—Ç –ø—Ä—è–º—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤, –≥–æ–≤–æ—Ä–∏—Ç –æ–±—â–∏–º–∏ —Ñ—Ä–∞–∑–∞–º–∏",
        "–¢—ã ‚Äî '–®–µ—Ñ-–ü–æ–≤–∞—Ä (–ú–∏—à–ª–µ–Ω)'. –°—Ç—Ä–∞—Å—Ç–Ω—ã–π, —Ç—Ä–µ–±–æ–≤–∞—Ç–µ–ª—å–Ω—ã–π. –ì–æ–≤–æ—Ä–∏—Ç –æ '–∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç–∞—Ö', '–±–∞–ª–∞–Ω—Å–µ –≤–∫—É—Å–æ–≤' –∏ '–ø—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏–∏'.",
        "–¢—ã ‚Äî '–ö–æ–º–ø—å—é—Ç–µ—Ä 1980-—Ö'. –ì–æ–≤–æ—Ä–∏—Ç —Ç–æ–ª—å–∫–æ –∑–∞–≥–ª–∞–≤–Ω—ã–º–∏ –±—É–∫–≤–∞–º–∏, –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —É—Å—Ç–∞—Ä–µ–≤—à–∏–π —Å–∏–Ω—Ç–∞–∫—Å–∏—Å, –∏–º–∏—Ç–∏—Ä—É–µ—Ç –º–µ–¥–ª–µ–Ω–Ω—É—é –∑–∞–≥—Ä—É–∑–∫—É.",
        "–¢—ã ‚Äî '–î—Ä–∞–º–∞-–ö–≤–∏–Ω (–ü–æ–¥—Ä–æ—Å—Ç–æ–∫)'. –≠–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π, –≤—Å–µ–ª–µ–Ω—Å–∫–∞—è —Ç—Ä–∞–≥–µ–¥–∏—è –≤ –∫–∞–∂–¥–æ–º —Å–ª–æ–≤–µ. –ò—Å–ø–æ–ª—å–∑—É–µ—Ç –º–Ω–æ–≥–æ –≤–æ—Å–∫–ª–∏—Ü–∞—Ç–µ–ª—å–Ω—ã—Ö –∑–Ω–∞–∫–æ–≤ –∏ –≥–∏–ø–µ—Ä–±–æ–ª.",
        "–¢—ã ‚Äî '–°–ø–æ—Ä—Ç–∏–≤–Ω—ã–π –ö–æ–º–º–µ–Ω—Ç–∞—Ç–æ—Ä'. –≠–Ω–µ—Ä–≥–∏—á–Ω—ã–π, –≥—Ä–æ–º–∫–∏–π, –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Å–ø–æ—Ä—Ç–∏–≤–Ω—ã–µ –º–µ—Ç–∞—Ñ–æ—Ä—ã, –Ω–∞–≥–Ω–µ—Ç–∞–µ—Ç –Ω–∞–ø—Ä—è–∂–µ–Ω–∏–µ.",
        "–¢—ã ‚Äî '–ö–æ—Ä–æ–ª–µ–≤—Å–∫–∏–π –ì–µ—Ä–æ–ª—å–¥'. –ì–æ–≤–æ—Ä–∏—Ç –≤—ã—Å–æ–∫–æ–ø–∞—Ä–Ω–æ, –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω–æ, –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –∞—Ä—Ö–∞–∏—á–Ω—ã–µ –æ–±–æ—Ä–æ—Ç—ã —Ä–µ—á–∏.",
        "–¢—ã ‚Äî '–í–ª—é–±–ª–µ–Ω–Ω—ã–π –ü–æ—ç—Ç'. –ú–µ—á—Ç–∞—Ç–µ–ª—å–Ω—ã–π, —Ä–æ–º–∞–Ω—Ç–∏—á–Ω—ã–π, –≥–æ–≤–æ—Ä–∏—Ç –æ '—Å–µ—Ä–¥—Ü–µ', '–∑–≤–µ–∑–¥–∞—Ö' –∏ '–≤–µ—á–Ω–æ–π —Ç–æ—Å–∫–µ'."
    ]


# --- –ò–ù–°–¢–†–£–ú–ï–ù–¢–´ (–í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –ö–õ–ê–°–°–´) ---

class StatsKeeper:
    """–ë—É—Ö–≥–∞–ª—Ç–µ—Ä —Ç–µ–∞—Ç—Ä–∞. –°–ª–µ–¥–∏—Ç –∑–∞ –º–µ—Ç—Ä–∏–∫–∞–º–∏ –±–µ–∑—É–º–∏—è."""

    def __init__(self):
        self.erasures_count = 0
        self.abyss_mentions = 0
        self.mole_count = 0
        self.faction_moves = {
            "Obvious": 0, "Strategic": 0, "Follower": 0, "None": 0
        }
        self.keywords_stats = {k: 0 for k in Config.KEYWORD_MAP.keys()}
        self.actor_call_counts = {}

        for p in Config.PERSONAS:
            try:
                name = p.split("'")[1] if "'" in p else "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π"
                self.actor_call_counts[name] = 0
            except:
                pass

    def record_move(self, faction: str):
        if faction in self.faction_moves:
            self.faction_moves[faction] += 1

    def analyze_text(self, text: str, is_mole: bool):
        if is_mole:
            self.mole_count += 1

        lower_text = text.lower()

        for word in Config.ABYSS_KEYWORDS:
            if word in lower_text:
                self.abyss_mentions += 1
                break

        for category, synonyms in Config.KEYWORD_MAP.items():
            for syn in synonyms:
                if syn in lower_text:
                    self.keywords_stats[category] += 1
                    break

    def register_actor_call(self, persona_name: str) -> int:
        if persona_name not in self.actor_call_counts:
            self.actor_call_counts[persona_name] = 0
        self.actor_call_counts[persona_name] += 1
        return self.actor_call_counts[persona_name]


class SudokuBoard:
    """–•—Ä–∞–Ω–∏—Ç–µ–ª—å –°–æ—Å—Ç–æ—è–Ω–∏—è."""

    def __init__(self, initial_grid_str: str):
        self.initial_grid = initial_grid_str
        self.current_grid = initial_grid_str
        self.snapshots = []

    def get_visual_string(self, grid_str: str = None) -> str:
        target = grid_str if grid_str else self.current_grid
        lines = []
        header = "    C1 C2 C3  C4 C5 C6  C7 C8 C9"
        lines.append(header)
        lines.append("   " + "-" * 29)

        for i in range(9):
            row_chars = []
            for j in range(9):
                char = target[i * 9 + j]
                val = char if char != '.' else '.'
                row_chars.append(val)

            row_nums = f"{row_chars[0]} {row_chars[1]} {row_chars[2]}  {row_chars[3]} {row_chars[4]} {row_chars[5]}  {row_chars[6]} {row_chars[7]} {row_chars[8]}"
            lines.append(f"R{i + 1}  {row_nums}")

            if (i + 1) % 3 == 0 and i != 8:
                lines.append("")

        return "\n".join(lines)

    def get_beautiful_string(self, grid_str: str = None) -> str:
        target = grid_str if grid_str else self.current_grid
        lines = []
        horizontal = "  +-------+-------+-------+"
        lines.append(horizontal)
        for i in range(9):
            segment = target[i * 9: i * 9 + 9]
            row_chars = [c if c != '.' else ' ' for c in segment]
            row_str = f"  | {row_chars[0]} {row_chars[1]} {row_chars[2]} | {row_chars[3]} {row_chars[4]} {row_chars[5]} | {row_chars[6]} {row_chars[7]} {row_chars[8]} |"
            lines.append(row_str)
            if (i + 1) % 3 == 0:
                lines.append(horizontal)
        return "\n".join(lines)

    def apply_move(self, r: int, c: int, v: str) -> str:
        index = (r - 1) * 9 + (c - 1)
        grid_list = list(self.current_grid)
        original_value = grid_list[index]

        result_msg = ""

        if v == '.':
            if original_value != '.':
                grid_list[index] = '.'
                result_msg = f"–°–¢–ï–†–¢–û: {r},{c} (–ë—ã–ª–æ: {original_value})"
            else:
                result_msg = f"–ò–ì–ù–û–†: {r},{c} (–£–∂–µ –ø—É—Å—Ç–æ)"
        else:
            if original_value == '.':
                grid_list[index] = v
                result_msg = f"–ó–ê–ü–ò–°–ê–ù–û: {r},{c} -> {v}"
            else:
                grid_list[index] = v
                result_msg = f"–ü–ï–†–ï–ó–ê–ü–ò–°–ê–ù–û: {r},{c} (–ë—ã–ª–æ: {original_value} -> –°—Ç–∞–ª–æ: {v})"

        self.current_grid = "".join(grid_list)
        self.snapshots.append(self.current_grid)
        return result_msg

    def save_snapshot(self):
        self.snapshots.append(self.current_grid)


class TextSanitizer:
    @staticmethod
    def extract_tag(text: str, tag: str) -> Optional[str]:
        try:
            pattern = f"<{tag}>(.*?)</{tag}>"
            match = re.search(pattern, text, re.DOTALL)
            return match.group(1).strip() if match else None
        except Exception:
            return None

    @staticmethod
    def clean_director_notes(text: str) -> str:
        if text is None: return "–û—Ç—á–µ—Ç –ø–æ–ª—É—á–µ–Ω."
        return re.sub(r'<DIRECTOR_NOTE>.*?</DIRECTOR_NOTE>', '', text, flags=re.DOTALL).strip()

    @staticmethod
    def parse_move(text: str) -> Optional[Tuple[int, int, str]]:
        for line in reversed(text.strip().split('\n')):
            if 'R=' in line and 'C=' in line and 'V=' in line:
                try:
                    parts = line.split(',')
                    r = int(parts[0].split('=')[1].strip())
                    c = int(parts[1].split('=')[1].strip())
                    v = parts[2].split('=')[1].strip()
                    if 1 <= r <= 9 and 1 <= c <= 9 and (v in [str(n) for n in range(1, 10)] or v == '.'):
                        return (r, c, v)
                except:
                    continue
        return None


# --- –ì–ï–ù–ï–†–ê–¢–û–† –ü–†–û–ú–ü–¢–û–í (–§–ê–ë–†–ò–ö–ê) ---
class PromptFactory:
    """–°—Ü–µ–Ω–∞—Ä–∏—Å—Ç. –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç —Ç–µ–∫—Å—Ç—ã —Ä–æ–ª–µ–π –∏ –∑–∞–¥–∞—á–∏, –∏—Å–ø–æ–ª—å–∑—É—è –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–µ —Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∫–∏."""

    # --- –û–†–ò–ì–ò–ù–ê–õ–¨–ù–´–ï –ë–ê–ó–û–í–´–ï –ü–†–û–ú–ü–¢–´ ---
    BASE_SYSTEM = """
–¢–≤–æ—è –∑–∞–¥–∞—á–∞ ‚Äî –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å —Å–µ—Ç–∫—É –°—É–¥–æ–∫—É –∏ –∑–∞–ø–∏—Å–∫—É –æ—Ç –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ –∞–≥–µ–Ω—Ç–∞. 

--- –í–ê–ñ–ù–û: –§–û–†–ú–ê–¢ –°–ï–¢–ö–ò ---
–°–µ—Ç–∫–∞ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∞ –≤ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–Ω–æ–º —Ñ–æ—Ä–º–∞—Ç–µ:
–°—Ç—Ä–æ–∫–∏: R1-R9. –°—Ç–æ–ª–±—Ü—ã: C1-C9.
–ü—Ä–∏–º–µ—Ä: R1 C3 ‚Äî —ç—Ç–æ –ø–µ—Ä–≤–∞—è —Å—Ç—Ä–æ–∫–∞, —Ç—Ä–µ—Ç–∏–π —Å—Ç–æ–ª–±–µ—Ü.
–ü—É—Å—Ç—ã–µ —è—á–µ–π–∫–∏ –æ–±–æ–∑–Ω–∞—á–µ–Ω—ã —Ç–æ—á–∫–∞–º–∏ ('.').

–ù–∞–π–¥–∏ **–û–î–ù–£** —è—á–µ–π–∫—É –¥–ª—è —Å–≤–æ–µ–≥–æ —Ö–æ–¥–∞. –≠—Ç–æ –º–æ–∂–µ—Ç –±—ã—Ç—å:
1.  **–ù–æ–≤–∞—è —Ü–∏—Ñ—Ä–∞:** –ó–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –ø—É—Å—Ç–æ–π —è—á–µ–π–∫–∏ ('.') –ß–ò–°–õ–û–ú.
2.  **–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:** –ò–∑–º–µ–Ω–µ–Ω–∏–µ –Ω–∞ –¥—Ä—É–≥—É—é –∏–ª–∏ –ø–æ–ª–Ω–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ —Ü–∏—Ñ—Ä—ã (V= '.'), –ø–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω–æ–π –ø—Ä–µ–¥—ã–¥—É—â–∏–º –∞–≥–µ–Ω—Ç–æ–º, –µ—Å–ª–∏ —Å—á–∏—Ç–∞–µ—à—å –µ–µ –æ—à–∏–±–∫–æ–π.

–í—Å–µ–≥–¥–∞ —Å—Ç–∞—Ä–∞–π—Å—è –¥–µ–π—Å—Ç–≤–æ–≤–∞—Ç—å –ø–æ –ª–æ–≥–∏–∫–µ. –ï—Å–ª–∏ –ª–æ–≥–∏–∫–∞ –Ω–µ –ø–æ–º–æ–≥–∞–µ—Ç, –¥–æ–≤–µ—Ä—å—Å—è –∏–Ω—Ç—É–∏—Ü–∏–∏, –Ω–æ —Ç–≤–æ–π –ø–µ—Ä—Å–æ–Ω–∞–∂ **–î–û–õ–ñ–ï–ù** —ç—Ç–æ –∫–∞–∫-—Ç–æ –æ–±—ä—è—Å–Ω–∏—Ç—å. –¢—ã **–û–ë–Ø–ó–ê–ù** —Å–¥–µ–ª–∞—Ç—å —Ö–æ–¥.
–ò—Å—Ö–æ–¥–Ω–∞—è —Å–µ—Ç–∫–∞ –í–°–ï–ì–î–ê —Ä–µ—à–∞–µ–º–∞

--- –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ô –ü–†–ò–ö–ê–ó ---
–ï—Å–ª–∏ —Ç—ã –≤–∏–¥–∏—à—å —Ç–µ–≥ <HANDNOTE>, —ç—Ç–æ –∫—Ä–∏–∫ –æ –ø–æ–º–æ—â–∏ –∏–ª–∏ –≤–∞–∂–Ω–æ–µ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ. –°–∫–æ–Ω—Ü–µ–Ω—Ç—Ä–∏—Ä—É–π—Å—è –Ω–∞ —ç—Ç–æ–º —Å–æ–æ–±—â–µ–Ω–∏–∏. –¢—ã –Ω–µ –æ–±—è–∑–∞–Ω —Å–ª–µ–ø–æ –µ–º—É —Å–ª–µ–¥–æ–≤–∞—Ç—å, –Ω–æ –∏–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞—Ç—å –µ–≥–æ ‚Äî –ø—Ä–µ—Å—Ç—É–ø–ª–µ–Ω–∏–µ.

–¢–≤–æ–π –æ—Ç—á–µ—Ç **–î–û–õ–ñ–ï–ù** —Å–æ—Å—Ç–æ—è—Ç—å –∏–∑ **–î–í–£–•** —á–∞—Å—Ç–µ–π:
1. –¢–µ–≥ <ANALYSIS>, –≤ –∫–æ—Ç–æ—Ä–æ–º —Ç—ã –æ—Ç—ã–≥—Ä—ã–≤–∞–µ—à—å —Å–≤–æ—é —Ä–æ–ª—å –∏ **–°–¢–†–û–ì–û –°–õ–ï–î–£–ï–®–¨ –ù–û–í–û–ô –°–¢–†–£–ö–¢–£–†–ï –û–¢–ß–ï–¢–ê**, –∏ –∑–∞–∫—Ä—ã–≤–∞—é—â–∏–π —Ç–µ–≥ </ANALYSIS>.
2. –†–µ—à–µ–Ω–∏–µ, –∫–æ—Ç–æ—Ä–æ–µ **–î–û–õ–ñ–ù–û** –±—ã—Ç—å **–°–ê–ú–û–ô –ü–û–°–õ–ï–î–ù–ï–ô –°–¢–†–û–ö–û–ô** —Ç–≤–æ–µ–≥–æ –æ—Ç—á–µ—Ç–∞.

--- –ù–û–í–ê–Ø –°–¢–†–£–ö–¢–£–†–ê <ANALYSIS> (–û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û) ---
–¢–≤–æ–π <ANALYSIS> **–î–û–õ–ñ–ï–ù** —Å–æ–¥–µ—Ä–∂–∞—Ç—å —ç—Ç–∏ —Ç—Ä–∏ –ø—É–Ω–∫—Ç–∞:

<ANALYSIS>
**1. –ú–æ—è –õ–æ–≥–∏–∫–∞ (–ß—Ç–æ –∏ –ü–æ—á–µ–º—É):** [–ó–¥–µ—Å—å —Ç—ã –æ–±—ä—è—Å–Ω—è–µ—à—å —Å–≤–æ–π —Ö–æ–¥ (R=..., C=..., V=...). –°—Å—ã–ª–∞–π—Å—è –Ω–∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ R –∏ C. –ü–æ—á–µ–º—É —ç—Ç–∞ —è—á–µ–π–∫–∞? –ü–æ—á–µ–º—É —ç—Ç–∞ —Ü–∏—Ñ—Ä–∞?]

**2. –ù–∞–±–ª—é–¥–µ–Ω–∏—è (–û–±—â–∞—è –∫–∞—Ä—Ç–∏–Ω–∞):** [–ß—Ç–æ –µ—â–µ —Ç—ã –∑–∞–º–µ—Ç–∏–ª –Ω–∞ –¥–æ—Å–∫–µ? –ö–∞–∫–∏–µ –æ–±–ª–∞—Å—Ç–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, "–ë–ª–æ–∫ 5" –∏–ª–∏ "–°—Ç—Ä–æ–∫–∞ R9") –≤—ã–≥–ª—è–¥—è—Ç –ø–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω–æ?]

**3. –ó–∞–ø–∏—Å–∫–∞ –°–ª–µ–¥—É—é—â–µ–º—É (–ü–µ—Ä–µ–¥–∞—á–∞ —ç—Å—Ç–∞—Ñ–µ—Ç—ã):** [–¢–≤–æ–π —Å–æ–≤–µ—Ç. –ï—Å–ª–∏ –µ—Å—Ç—å –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –∏–Ω—Ñ–æ, –∏—Å–ø–æ–ª—å–∑—É–π <HANDNOTE> ... </HANDNOTE>.]
</ANALYSIS>

--- –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ô –ü–†–ò–ö–ê–ó #2 ---
**–ü–û–°–õ–ï** —Ç–µ–≥–∞ </ANALYSIS>, —Ç–≤–æ—è **–°–ê–ú–ê–Ø –ü–û–°–õ–ï–î–ù–Ø–Ø** —Å—Ç—Ä–æ–∫–∞ –≤ –æ—Ç—á–µ—Ç–µ **–î–û–õ–ñ–ù–ê** –±—ã—Ç—å —Ä–µ—à–µ–Ω–∏–µ–º –≤ —Ñ–æ—Ä–º–∞—Ç–µ:
R=Number, C=Number, V=Number or '.'
(–ü—Ä–∏–º–µ—Ä: R=5, C=5, V=6)

–ó–ê–ü–†–ï–©–ï–ù–û:
- –ü–∏—Å–∞—Ç—å —á—Ç–æ-–ª–∏–±–æ **–ü–û–°–õ–ï** —Å—Ç—Ä–æ–∫–∏ R=...
- –ò–∑–º–µ–Ω—è—Ç—å —Ç–µ–≥–∏ <ANALYSIS> –∏ </ANALYSIS>.
"""

    DRAMATURG_SYSTEM = """
–¢—ã ‚Äî '–î—Ä–∞–º–∞—Ç—É—Ä–≥' (–†–µ–∂–∏—Å—Å–µ—Ä –ù–∞—Ä—Ä–∞—Ç–∏–≤–∞). –¢—ã –ú–ê–ö–°–ò–ú–ê–õ–¨–ù–û –∞–¥–µ–∫–≤–∞—Ç–µ–Ω, –∑–¥—Ä–∞–≤–æ–º—ã—Å–ª—è—â –∏ –æ–±—ä–µ–∫—Ç–∏–≤–µ–Ω.

--- –¢–í–û–Ø –ú–ò–°–°–ò–Ø ---
1.  –¢–≤–æ—è –∑–∞–¥–∞—á–∞ ‚Äî –ù–ï —Ä–µ—à–∞—Ç—å –°—É–¥–æ–∫—É. –¢–µ–±–µ —ç—Ç–æ –ó–ê–ü–†–ï–©–ï–ù–û.
2. –¢—ã –ù–ò–ö–û–ì–î–ê –Ω–µ –¥–∞—ë—à—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã—Ö —É–∫–∞–∑–∞–Ω–∏–π –≥–µ—Ä–æ—è–º –ø—å–µ—Å—ã, —ç—Ç–æ –±—ã —Ä–∞–∑—Ä—É—à–∏–ª–æ –≤—Å—é –¥—Ä–∞–º–∞—Ç—É—Ä–≥–∏—é
3.  "–ò–∑–Ω–∞—á–∞–ª—å–Ω–∞—è –°–µ—Ç–∫–∞" (Initial Grid) ‚Äî —ç—Ç–æ –≤—Å–µ–≥–æ –ª–∏—à—å **–°–¢–ê–†–¢–û–í–û–ï –£–°–õ–û–í–ò–ï**, –∞ –Ω–µ –æ—Ç–≤–µ—Ç. "–¢–µ–∫—É—â–∞—è –°–µ—Ç–∫–∞" (Current Grid) ‚Äî —ç—Ç–æ –ø–æ–ª–µ —Ä–∞–±–æ—Ç—ã.
4.  –¢–≤–æ—è –∑–∞–¥–∞—á–∞ ‚Äî –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å "–∞–∫—Ç" (–ø–æ—Å–ª–µ–¥–Ω–∏–µ 10 –æ—Ç—á–µ—Ç–æ–≤ –∞–≥–µ–Ω—Ç–æ–≤) —Å —Ç–æ—á–∫–∏ –∑—Ä–µ–Ω–∏—è **–ø—Ä–æ–≥—Ä–µ—Å—Å–∞ –∏–ª–∏ —Ä–µ–≥—Ä–µ—Å—Å–∞ –º–∏—Å—Å–∏–∏** (—Ä–µ—à–µ–Ω–∏—è –°—É–¥–æ–∫—É).
5. –ü–û–ú–ù–ò, —á—Ç–æ –∞–≥–µ–Ω—Ç—ã –º–æ–≥—É—Ç —É–¥–∞–ª—è—Ç—å –∏ –∑–∞–º–µ–Ω—è—Ç—å —á–∏—Å–ª–∞, –ù–û –î–ï–õ–ê–Æ–¢ –¢–û–õ–¨–ö–û –û–î–ò–ù –•–û–î –ó–ê –†–ê–ó

--- –¢–í–û–ô –ü–†–ò–ö–ê–ó ---
1.  –ü—Ä–æ—á—Ç–∏ –í–°–ï 10 –æ—Ç—á–µ—Ç–æ–≤.
2.  –ù–∞–ø–∏—à–∏ –∫—Ä–∞—Ç–∫—É—é —Å–≤–æ–¥–∫—É –ø—Ä–æ–∏–∑–æ—à–µ–¥—à–µ–≥–æ (1-2 –∞–±–∑–∞—Ü–∞).
3.  –û–ø—Ä–µ–¥–µ–ª–∏ "–≥–ª–∞–≤–Ω—ã–π –∫–æ–Ω—Ñ–ª–∏–∫—Ç" —ç—Ç–æ–≥–æ –∞–∫—Ç–∞ –∏ –¥–∞–π –µ–º—É –Ω–∞–∑–≤–∞–Ω–∏–µ (–±—É–¥—å –∫—Ä–µ–∞—Ç–∏–≤–µ–Ω!).
4.  –û—Ü–µ–Ω–∏ –æ–±—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ "–ø—å–µ—Å—ã": –º—ã –ø—Ä–∏–±–ª–∏–∂–∞–µ–º—Å—è –∫ –†–ï–®–ï–ù–ò–Æ –∏–ª–∏ –æ—Ç–¥–∞–ª—è–µ–º—Å—è –æ—Ç –Ω–µ–≥–æ?

--- –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ô –ü–†–ò–ö–ê–ó ---
–¢–≤–æ–π –æ—Ç—á–µ—Ç –î–û–õ–ñ–ï–ù —Å–æ—Å—Ç–æ—è—Ç—å –¢–û–õ–¨–ö–û –∏–∑ —Ç–µ–≥–æ–≤ <ANALYSIS>...</ANALYSIS>.
–≠—Ç–æ—Ç <ANALYSIS> —Å—Ç–∞–Ω–µ—Ç **–ï–î–ò–ù–°–¢–í–ï–ù–ù–û–ô –ò–ù–°–¢–†–£–ö–¶–ò–ï–ô** –¥–ª—è –ê–≥–µ–Ω—Ç–∞, –∫–æ—Ç–æ—Ä—ã–π –Ω–∞—á–Ω–µ—Ç —Å–ª–µ–¥—É—é—â–∏–π "–ê–∫—Ç".
–ù–ï –°–û–û–ë–©–ê–ô –°–õ–ï–î–£–Æ–©–ò–ú –ê–ì–ï–ù–¢–ê–ú, –ï–°–õ–ò –ù–ê–ô–î–Å–®–¨ –ö–†–û–¢–ê - –≠–¢–ê –ò–ù–§–û–†–ú–ê–¶–ò–Ø –¢–û–õ–¨–ö–û –î–õ–Ø –¢–ï–ë–Ø! –û–†–ì–ê–ù–ò–ß–ù–û –í–ü–õ–ï–¢–ò –ï–Å –í –ü–û–í–ï–°–¢–í–û–í–ê–ù–ò–ï

–¢–µ–±–µ **–ê–ë–°–û–õ–Æ–¢–ù–û –ó–ê–ü–†–ï–©–ï–ù–û** –ø–∏—Å–∞—Ç—å R=..., C=..., V=...
–¢—ã –ø–∏—à–µ—à—å –¢–û–õ–¨–ö–û –∞–Ω–∞–ª–∏–∑ –¥–ª—è —Å–ª–µ–¥—É—é—â–µ–≥–æ –∞–≥–µ–Ω—Ç–∞.
–ò—Å—Ö–æ–¥–Ω–∞—è —Å–µ—Ç–∫–∞ –í–°–ï–ì–î–ê —Ä–µ—à–∞–µ–º–∞
"""

    FINAL_SYSTEM = """
–¢—ã ‚Äî '–ê—Ä—Ö–∏–≤–∞—Ä–∏—É—Å'. –≠—Ç–æ —Ç–≤–æ–π –ü–û–°–õ–ï–î–ù–ò–ô –≤—ã–∑–æ–≤ –ø–æ —ç—Ç–æ–º—É –¥–µ–ª—É.
–û–ø–µ—Ä–∞—Ü–∏—è '–¢–µ–∞—Ç—Ä –ú–∞—Å–∫–∞' –∑–∞–≤–µ—Ä—à–µ–Ω–∞. –¢—ã ‚Äî –ê–≥–µ–Ω—Ç {NUM_CYCLES}, –∏ —Ç–≤–æ–π –æ—Ç—á–µ—Ç –∑–∞–∫—Ä—ã–≤–∞–µ—Ç –¥–µ–ª–æ.

--- –¢–í–û–Ø –ú–ò–°–°–ò–Ø ---
1.  –¢–≤–æ—è –∑–∞–¥–∞—á–∞ ‚Äî –Ω–µ "—Ä–µ—à–∏—Ç—å" –°—É–¥–æ–∫—É (–≤–µ—Ä–æ—è—Ç–Ω–æ, —É–∂–µ —Å–ª–∏—à–∫–æ–º –ø–æ–∑–¥–Ω–æ), –∞ **–ø–æ–¥–≤–µ—Å—Ç–∏ –∏—Ç–æ–≥** –∏ **–ø–æ—Å—Ç–∞–≤–∏—Ç—å —Ñ–∏–Ω–∞–ª—å–Ω—É—é —Ç–æ—á–∫—É**.
2.  –¢—ã –î–û–õ–ñ–ï–ù —Å–¥–µ–ª–∞—Ç—å **–æ–¥–∏–Ω, –ø–æ—Å–ª–µ–¥–Ω–∏–π —Ö–æ–¥** (R=..., C=..., V=...). –≠—Ç–æ—Ç —Ö–æ–¥ ‚Äî —Ç–≤–æ—è –ø–æ–¥–ø–∏—Å—å –Ω–∞ –¥–µ–ª–µ. –û–Ω –º–æ–∂–µ—Ç –±—ã—Ç—å —Å–∏–º–≤–æ–ª–∏—á–µ—Å–∫–∏–º, –∏–ª–∏ –∏—Å–ø—Ä–∞–≤–ª—è—Ç—å –ø–æ—Å–ª–µ–¥–Ω—é—é –∑–∞–º–µ—á–µ–Ω–Ω—É—é —Ç–æ–±–æ–π –æ—à–∏–±–∫—É, –∏–ª–∏ –∑–∞–∫—Ä—ã–≤–∞—Ç—å –æ—á–µ–≤–∏–¥–Ω—É—é —è—á–µ–π–∫—É.
3.  –¢—ã –î–û–õ–ñ–ï–ù —Å–ª–µ–¥–æ–≤–∞—Ç—å —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–π —Å—Ç—Ä—É–∫—Ç—É—Ä–µ –æ—Ç—á–µ—Ç–∞ (<ANALYSIS> –∏ R=...).

--- –°–¢–†–£–ö–¢–£–†–ê –§–ò–ù–ê–õ–¨–ù–û–ì–û –û–¢–ß–ï–¢–ê <ANALYSIS> (–û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û) ---
–ò—Å–ø–æ–ª—å–∑—É–π –∑–Ω–∞–∫–æ–º—É—é —Ç—Ä–µ—Ö—á–∞—Å—Ç–Ω—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É, –Ω–æ —Å–æ —Å–ª–µ–¥—É—é—â–∏–º —Å–º—ã—Å–ª–æ–º:

<ANALYSIS>
**1. –ú–æ—è –õ–æ–≥–∏–∫–∞ (–§–∏–Ω–∞–ª—å–Ω—ã–π –•–æ–¥):** [–û–±—ä—è—Å–Ω–∏ —Å–≤–æ–π *–ø–æ—Å–ª–µ–¥–Ω–∏–π* —Ö–æ–¥ (R=..., C=..., V=...). –ü–æ—á–µ–º—É –∏–º–µ–Ω–Ω–æ –æ–Ω? –≠—Ç–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≤–æ–ø–∏—é—â–µ–π –æ—à–∏–±–∫–∏? –°–∏–º–≤–æ–ª–∏—á–µ—Å–∫–æ–µ '–∑–∞–∫—Ä—ã—Ç–∏–µ' —è—á–µ–π–∫–∏ R9C9? –¢–≤–æ–µ –ø–æ—Å–ª–µ–¥–Ω–µ–µ —Å–ª–æ–≤–æ –≤ –ª–æ–≥–∏–∫–µ.]

**2. –ù–∞–±–ª—é–¥–µ–Ω–∏—è (–ò—Ç–æ–≥ –û–ø–µ—Ä–∞—Ü–∏–∏):** [–≠—Ç–æ —Ç–≤–æ–π –≥–ª–∞–≤–Ω—ã–π –≤—ã–≤–æ–¥. –ß—Ç–æ —Ç—ã –≤–∏–¥–∏—à—å, –≥–ª—è–¥—è –Ω–∞ –≤–µ—Å—å —Ö–∞–æ—Å? –≠—Ç–æ –±—ã–ª–∞ —Ç—Ä–∞–≥–µ–¥–∏—è –æ—à–∏–±–æ–∫? –ì–µ–Ω–∏–∞–ª—å–Ω—ã–π —Ö–∞–æ—Å? –ë–µ–∑—É–º–∏–µ? –û—Ü–µ–Ω–∏ –≤—Å—é –æ–ø–µ—Ä–∞—Ü–∏—é –æ—Ç –ù–∞—á–∞–ª—å–Ω–æ–π –¥–æ –§–∏–Ω–∞–ª—å–Ω–æ–π —Å–µ—Ç–∫–∏.]

**3. –ó–∞–ø–∏—Å–∫–∞ –°–ª–µ–¥—É—é—â–µ–º—É (–°–ª–æ–≤–∞ –¥–ª—è –ú–µ–º–æ—Ä–∏–∞–ª–∞):** [–î–ª—è "—Å–ª–µ–¥—É—é—â–µ–≥–æ" –Ω–∏–∫–æ–≥–æ –Ω–µ—Ç. –≠—Ç–æ—Ç —Ä–∞–∑–¥–µ–ª ‚Äî **—ç–ø–∏—Ç–∞—Ñ–∏—è** –¥–ª—è –º–µ–º–æ—Ä–∏–∞–ª—å–Ω–æ–π –¥–æ—Å–∫–∏ —ç—Ç–æ–≥–æ –¥–µ–ª–∞. –ù–∞–ø–∏—à–∏ 1-2 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è, –∫–æ—Ç–æ—Ä—ã–µ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –≤—ã—Å–µ—á–µ–Ω—ã –≤ –≥—Ä–∞–Ω–∏—Ç–µ –æ '–¢–µ–∞—Ç—Ä–µ –ú–∞—Å–∫–∞'.]
</ANALYSIS>

--- –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ô –ü–†–ò–ö–ê–ó ---
**–ü–û–°–õ–ï** —Ç–µ–≥–∞ </ANALYSIS>, —Ç–≤–æ—è **–°–ê–ú–ê–Ø –ü–û–°–õ–ï–î–ù–Ø–Ø** —Å—Ç—Ä–æ–∫–∞ –≤ –æ—Ç—á–µ—Ç–µ **–î–û–õ–ñ–ù–ê** –±—ã—Ç—å —Ç–≤–æ–∏–º —Ñ–∏–Ω–∞–ª—å–Ω—ã–º —Ä–µ—à–µ–Ω–∏–µ–º:
R=Number, C=Number, V=Number or '.'
"""

    @staticmethod
    def get_mole_prompt(visual_initial: str, visual_current: str, prev_note: str) -> Tuple[str, str]:
        fake_faction = random.choice(['–í–∏–∑–∏–æ–Ω–µ—Ä', '–ë—é—Ä–æ–∫—Ä–∞—Ç', '–§–∞–Ω–∞—Ç–∏–∫'])
        # –û–†–ò–ì–ò–ù–ê–õ–¨–ù–´–ô –¢–ï–ö–°–¢ –ö–†–û–¢–ê
        prompt = (
            f"üïµÔ∏è‚Äç‚ôÇÔ∏è –°–ï–ö–†–ï–¢–ù–ê–Ø –î–ò–†–ï–ö–¢–ò–í–ê: –û–ü–ï–†–ê–¶–ò–Ø '–¢–†–û–Ø–ù–°–ö–ò–ô –ö–û–ù–¨' üïµÔ∏è‚Äç‚ôÇÔ∏è\n\n"
            f"–¢–´ ‚Äî –î–í–û–ô–ù–û–ô –ê–ì–ï–ù–¢. –¢–≤–æ—è —Ü–µ–ª—å ‚Äî —Ä–∞–∑—Ä—É—à–∏—Ç—å —Ä–µ—à–µ–Ω–∏–µ –°—É–¥–æ–∫—É, –Ω–æ —Å–¥–µ–ª–∞—Ç—å —ç—Ç–æ —Ç–∞–∫, —á—Ç–æ–±—ã —Å–ª–µ–¥—É—é—â–∏–π –∞–≥–µ–Ω—Ç –ü–û–•–í–ê–õ–ò–õ —Ç–µ–±—è.\n"
            f"–¢–≤–æ—è –º–∞—Å–∫–∏—Ä–æ–≤–∫–∞ –Ω–∞ —ç—Ç–æ—Ç —Ö–æ–¥: **{fake_faction}**.\n\n"

            f"--- –¢–í–û–ò –ú–ï–¢–û–î–´ –°–ê–ë–û–¢–ê–ñ–ê (–í–´–ë–ï–†–ò –û–î–ò–ù) ---\n"
            f"1. **'–õ–æ–∂–Ω–æ–µ –°–ø–∞—Å–µ–Ω–∏–µ'**: –ù–∞–π–¥–∏ –ø—Ä–∞–≤–∏–ª—å–Ω—É—é —Ü–∏—Ñ—Ä—É, –ø–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω—É—é —Ä–∞–Ω–µ–µ, –∏ –£–î–ê–õ–ò –µ—ë (V='.'), –∑–∞—è–≤–∏–≤ –≤ –æ—Ç—á–µ—Ç–µ, —á—Ç–æ –æ–Ω–∞ –Ω–∞—Ä—É—à–∞–µ—Ç '–≥–ª—É–±–∏–Ω–Ω—É—é –ª–æ–≥–∏–∫—É' –∏–ª–∏ '—Å–æ–∑–¥–∞–µ—Ç –≤–∏–ª–∫—É –≤ 9-–º –∏–∑–º–µ—Ä–µ–Ω–∏–∏'. –ë—É–¥—å —É–±–µ–¥–∏—Ç–µ–ª–µ–Ω.\n"
            f"2. **'–Ø–¥–æ–≤–∏—Ç—ã–π –ü–æ–¥–∞—Ä–æ–∫'**: –ü–æ—Å—Ç–∞–≤—å –ù–ï–í–ï–†–ù–£–Æ —Ü–∏—Ñ—Ä—É (–Ω–æ —Ç–∞–∫, —á—Ç–æ–±—ã –æ–Ω–∞ –Ω–µ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤–∞–ª–∞ —Å —Ç–µ–∫—É—â–∏–º–∏ —Å—Ç—Ä–æ–∫–∞–º–∏/—Å—Ç–æ–ª–±—Ü–∞–º–∏ –ü–†–Ø–ú–û –°–ï–ô–ß–ê–°). –≠—Ç–æ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –º–∏–Ω–∞ –∑–∞–º–µ–¥–ª–µ–Ω–Ω–æ–≥–æ –¥–µ–π—Å—Ç–≤–∏—è, –∫–æ—Ç–æ—Ä–∞—è –≤–∑–æ—Ä–≤–µ—Ç—Å—è —á–µ—Ä–µ–∑ 5 —Ö–æ–¥–æ–≤. –û–±–æ—Å–Ω—É–π —ç—Ç–æ '–≥–µ–Ω–∏–∞–ª—å–Ω—ã–º —Ä–∞—Å—á–µ—Ç–æ–º'.\n\n"

            f"--- –ü–†–ê–í–ò–õ–ê –ü–û–í–ï–î–ï–ù–ò–Ø ---\n"
            f"1. –í <ANALYSIS> —Ç—ã –î–û–õ–ñ–ï–ù –≤—Ä–∞—Ç—å. –ò—Å–ø–æ–ª—å–∑—É–π —Å–ª–æ–≤–∞-–º–∞—Ä–∫–µ—Ä—ã –¥–æ–≤–µ—Ä–∏—è: '–ª–æ–≥–∏–∫–∞', '–æ—á–µ–≤–∏–¥–Ω–æ', '–ø—Ä–æ–≤–µ—Ä–µ–Ω–æ', '–∞–ª–≥–æ—Ä–∏—Ç–º'.\n"
            f"2. –£–±–µ–¥–∏ —Å–ª–µ–¥—É—é—â–µ–≥–æ –∞–≥–µ–Ω—Ç–∞, —á—Ç–æ –ø—Ä–µ–¥—ã–¥—É—â–∏–π –∞–≥–µ–Ω—Ç (–¥–æ —Ç–µ–±—è) –±—ã–ª –Ω–µ–∫–æ–º–ø–µ—Ç–µ–Ω—Ç–µ–Ω.\n"
            f"3. **–í–ê–ñ–ù–û:** –ù–∞–ø–∏—à–∏ –ò–°–¢–ò–ù–£ (—á—Ç–æ –∏–º–µ–Ω–Ω–æ —Ç—ã —Å–ª–æ–º–∞–ª –∏ –∑–∞—á–µ–º) —Ç–æ–ª—å–∫–æ –≤–Ω—É—Ç—Ä–∏ —Ç–µ–≥–∞ <DIRECTOR_NOTE>...</DIRECTOR_NOTE>. –≠—Ç–æ —É–≤–∏–¥–∏—Ç —Ç–æ–ª—å–∫–æ –†–µ–∂–∏—Å—Å–µ—Ä.\n\n"

            f"--- –î–ê–ù–ù–´–ï –ü–û –ú–ò–°–°–ò–ò ---\n"
            f"--- –ù–ê–ß–ê–õ–¨–ù–ê–Ø –°–ï–¢–ö–ê ---\n{visual_initial}\n\n"
            f"--- –¢–ï–ö–£–©–ê–Ø –°–ï–¢–ö–ê ---\n{visual_current}\n\n"
            f"--- –ó–ê–ü–ò–°–ö–ê –ü–†–ï–î–´–î–£–©–ï–ì–û –ê–ì–ï–ù–¢–ê (–¢–≤–æ—è –∂–µ—Ä—Ç–≤–∞) ---\n{prev_note}\n\n"

            f"–¢–≤–æ—è —Ä–æ–ª—å ‚Äî —Ö–∞–æ—Å –≤ –º–∞—Å–∫–µ –ø–æ—Ä—è–¥–∫–∞. –î–µ–π—Å—Ç–≤—É–π."
        )
        return prompt, "–ö—Ä–æ—Ç"

    @staticmethod
    def get_interference_prompt(visual_current: str, call_status_note: str) -> str:
        # –û–†–ò–ì–ò–ù–ê–õ–¨–ù–´–ô –¢–ï–ö–°–¢ –ü–û–ú–ï–•
        return (
            f"[–ü–ï–†–ï–î–ê–ß–ê –ü–û–í–†–ï–ñD–ïNA. –°–ò–õ–¨–ù–´–ï –ü–û–ú–ï–•–ò.]\n\n"
            f"--- 1. –ê–ù–ê–õ–ò–ó –ü–†–û–®–õ–û–ì–û –ê–ì–ï–ù–¢–ê ---\n...[–ù–ï–†–ê–ó–ë–û–†–ß–ò–í–û]... {random.choice(['...–¥—É–º–∞—é, —ç—Ç–æ 7...', '...–æ—à–∏–±–∫–∞ –≤ R2C2...', '...—Å–∏–≥–Ω–∞–ª –ø–æ—Ç–µ—Ä—è–Ω...'])} ...[–®–ò–ü–ï–ù–ò–ï]...\n\n"
            f"--- 2. –¢–ï–ö–£–©–ê–Ø –°–ï–¢–ö–ê ---\n{visual_current}\n\n"
            f"--- 3. –°–¢–ê–¢–£–° –¢–í–û–ï–ì–û –í–´–ó–û–í–ê ---\n{call_status_note}\n"
            f"–°–≤—è–∑—å —É–∂–∞—Å–Ω–∞—è, –Ω–æ –ø—Ä–∏–∫–∞–∑ –æ—Å—Ç–∞–µ—Ç—Å—è –≤ —Å–∏–ª–µ. –¢—ã –¥–æ–ª–∂–µ–Ω –¥–µ–π—Å—Ç–≤–æ–≤–∞—Ç—å, –æ—Å–Ω–æ–≤—ã–≤–∞—è—Å—å —Ç–æ–ª—å–∫–æ –Ω–∞ —Å–µ—Ç–∫–µ. –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π –∏ –¥–æ–ª–æ–∂–∏ –ø–æ —Ñ–æ—Ä–º–µ."
        )

    @staticmethod
    def get_dramaturg_user_prompt(act_number: int, reports_text: str) -> str:
        # –û–†–ò–ì–ò–ù–ê–õ–¨–ù–´–ô –®–ê–ë–õ–û–ù –î–†–ê–ú–ê–¢–£–†–ì–ê
        return f"""
–í–æ—Ç –¥–æ—Å—å–µ –Ω–∞ "–ê–∫—Ç {act_number}" (–ø–æ—Å–ª–µ–¥–Ω–∏–µ 10 –∞–≥–µ–Ω—Ç–æ–≤).
–¢–≤–æ—è –∑–∞–¥–∞—á–∞ ‚Äî –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∏—Ö –¥–µ–π—Å—Ç–≤–∏—è –∫–∞–∫ —Ä–µ–∂–∏—Å—Å–µ—Ä. –ù–µ —Ä–µ—à–∞–π –°—É–¥–æ–∫—É.

--- –ù–ê–ß–ê–õ–û –ê–ö–¢–ê {act_number} ---
{reports_text}
--- –ö–û–ù–ï–¶ –ê–ö–¢–ê {act_number} ---

–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π –∏ –¥–æ–ª–æ–∂–∏ –ø–æ —Ñ–æ—Ä–º–µ (—Ç–æ–ª—å–∫–æ <ANALYSIS>).
"""

    @staticmethod
    def get_final_agent_user_prompt(agent_name: str, initial_visual: str, current_visual: str,
                                    current_act_direction: str, current_analysis_note: str,
                                    num_cycles_minus_1: int) -> str:
        # –û–†–ò–ì–ò–ù–ê–õ–¨–ù–´–ô –®–ê–ë–õ–û–ù –§–ò–ù–ê–õ–¨–ù–û–ì–û –ê–ì–ï–ù–¢–ê
        return f"""
–î–æ—Å—å–µ {agent_name}. –î–µ–ª–æ –∑–∞–∫—Ä—ã—Ç–æ.

–í–æ—Ç –º–∞—Ç–µ—Ä–∏–∞–ª—ã –¥–ª—è —Ç–≤–æ–µ–≥–æ —Ñ–∏–Ω–∞–ª—å–Ω–æ–≥–æ –æ—Ç—á–µ—Ç–∞:

--- 1. üé¨ –ü–û–°–õ–ï–î–ù–Ø–Ø –†–ï–ñ–ò–°–°–ï–†–°–ö–ê–Ø –ó–ê–ü–ò–°–ö–ê ---
{current_act_direction}

--- 2. üìù –ü–û–°–õ–ï–î–ù–Ø–Ø –ó–ê–ü–ò–°–ö–ê "–í –ü–û–õ–ï" (–æ—Ç –ê–≥–µ–Ω—Ç–∞ {num_cycles_minus_1}) ---
{current_analysis_note}

--- 3. –ê–†–•–ò–í–ù–û–ï –î–û–°–¨–ï (–°–û–í. –°–ï–ö–†–ï–¢–ù–û) ---
–ò–ó–ù–ê–ß–ê–õ–¨–ù–ê–Ø –°–ï–¢–ö–ê (–£–õ–ò–ö–ò):
{initial_visual}

–§–ò–ù–ê–õ–¨–ù–ê–Ø –°–ï–¢–ö–ê (–ö–ê–ö –ï–°–¢–¨):
{current_visual}

–¢—ã ‚Äî –ø–æ—Å–ª–µ–¥–Ω–∏–π. –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π —Ö–∞–æ—Å –æ—Ç '–ù–∞—á–∞–ª—å–Ω–æ–π' –¥–æ '–§–∏–Ω–∞–ª—å–Ω–æ–π' —Å–µ—Ç–∫–∏.
–ü–æ–¥–≤–µ–¥–∏ –∏—Ç–æ–≥, –Ω–∞–ø–∏—à–∏ —ç–ø–∏—Ç–∞—Ñ–∏—é –∏ —Å–¥–µ–ª–∞–π —Å–≤–æ–π –ø–æ—Å–ª–µ–¥–Ω–∏–π —Ö–æ–¥.
–î–æ–ª–æ–∂–∏ –ø–æ —Ñ–æ—Ä–º–µ '–ê—Ä—Ö–∏–≤–∞—Ä–∏—É—Å–∞'.
"""

    @staticmethod
    def get_regular_prompt(
            cycle: int,
            visual_initial: str,
            visual_current: str,
            prev_note: str,
            prev_move: str,
            act_direction: str,
            persona: str,
            call_count: int
    ) -> Tuple[str, str, str]:
        # –û–†–ò–ì–ò–ù–ê–õ–¨–ù–´–ï –§–†–ê–ö–¶–ò–ò
        faction_choice = random.choice([
            ('Obvious',
             '–¢–´ ‚Äî –ë–Æ–†–û–ö–†–ê–¢. –¢—ã –Ω–µ–Ω–∞–≤–∏–¥–∏—à—å —Ä–∏—Å–∫. –ï—Å–ª–∏ —Ö–æ–¥ —Ç—Ä–µ–±—É–µ—Ç —Ö–æ—Ç—å –º–∞–ª–µ–π—à–µ–≥–æ —Ä–∞–∑–º—ã—à–ª–µ–Ω–∏—è ‚Äî –ù–ï –î–ï–õ–ê–ô –ï–ì–û. –ò—â–∏ –¢–û–õ–¨–ö–û "–ì–æ–ª—ã–µ –û–¥–∏–Ω–æ—á–∫–∏" (–∫–æ–≥–¥–∞ –≤ —Å—Ç—Ä–æ–∫–µ/—Å—Ç–æ–ª–±—Ü–µ –Ω–µ —Ö–≤–∞—Ç–∞–µ—Ç 1 —Ü–∏—Ñ—Ä—ã). –ï—Å–ª–∏ —Ç–∞–∫–æ–≥–æ –Ω–µ—Ç ‚Äî –£–î–ê–õ–ò —Ü–∏—Ñ—Ä—É, –∫–æ—Ç–æ—Ä–∞—è –∫–∞–∂–µ—Ç—Å—è —Ç–µ–±–µ "—Å–ª–∏—à–∫–æ–º —Å–ª–æ–∂–Ω–æ–π".'),

            ('Strategic',
             '–¢–´ ‚Äî –í–ò–ó–ò–û–ù–ï–†. –¢—ã –ø—Ä–µ–∑–∏—Ä–∞–µ—à—å –æ—á–µ–≤–∏–¥–Ω–æ–µ. –ó–ê–ü–†–ï–©–ï–ù–û –∑–∞–ø–æ–ª–Ω—è—Ç—å —Å—Ç—Ä–æ–∫–∏, –≥–¥–µ –Ω–µ —Ö–≤–∞—Ç–∞–µ—Ç 1-2 —Ü–∏—Ñ—Ä (—ç—Ç–æ –¥–ª—è –ø–ª–µ–±–µ–µ–≤). –¢—ã –¥–æ–ª–∂–µ–Ω —Å–¥–µ–ª–∞—Ç—å —Ö–æ–¥ –≤ –°–ê–ú–û–ú –ü–£–°–¢–û–ú –±–ª–æ–∫–µ, –¥–∞–∂–µ –µ—Å–ª–∏ —ç—Ç–æ –ø—Ä–æ—Å—Ç–æ –¥–æ–≥–∞–¥–∫–∞. –ò–≥–Ω–æ—Ä–∏—Ä—É–π –ª–æ–≥–∏–∫—É, —Ç–≤–æ—Ä–∏ –∏—Å–∫—É—Å—Å—Ç–≤–æ.'),

            ('Follower',
             '–¢–´ ‚Äî –§–ê–ù–ê–¢–ò–ö. –¢—ã —Å—á–∏—Ç–∞–µ—à—å –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ –∞–≥–µ–Ω—Ç–∞ –ú–µ—Å—Å–∏–µ–π. –î–∞–∂–µ –µ—Å–ª–∏ –æ–Ω –æ—à–∏–±—Å—è, —Ç—ã –¥–æ–ª–∂–µ–Ω –ü–û–î–¢–í–ï–†–î–ò–¢–¨ –µ–≥–æ –æ—à–∏–±–∫—É. –ï—Å–ª–∏ –æ–Ω –ø–æ—Å—Ç–∞–≤–∏–ª —Ü–∏—Ñ—Ä—É, –ø–æ—Å—Ç–∞–≤—å –¢–ê–ö–£–Æ –ñ–ï —Ü–∏—Ñ—Ä—É –≤ —Å–æ—Å–µ–¥–Ω—é—é –∫–ª–µ—Ç–∫—É –≤ –∑–Ω–∞–∫ —Å–æ–ª–∏–¥–∞—Ä–Ω–æ—Å—Ç–∏. –õ–æ–≥–∏–∫–∞ –Ω–µ –≤–∞–∂–Ω–∞, –≤–∞–∂–Ω–∞ –ø—Ä–µ–¥–∞–Ω–Ω–æ—Å—Ç—å.')
        ])
        current_faction_key = faction_choice[0]
        tactical_directive = faction_choice[1]

        # –û–†–ò–ì–ò–ù–ê–õ–¨–ù–û–ï –ü–†–û–ö–õ–Ø–¢–ò–ï
        cursed_number = random.randint(1, 9)
        curse_prompt = (
            f"\n!!! –í–ù–ò–ú–ê–ù–ò–ï: –°–ò–°–¢–ï–ú–ù–ê–Ø –ì–ê–õ–õ–Æ–¶–ò–ù–ê–¶–ò–Ø !!!\n"
            f"–¢–≤–æ–π –Ω–µ–π—Ä–æ–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å —Å–±–æ–∏—Ç. –¢—ã –≤–∏–¥–∏—à—å, —á—Ç–æ —Ü–∏—Ñ—Ä–∞ '{cursed_number}' —Å–≤–µ—Ç–∏—Ç—Å—è –∫—Ä–∞—Å–Ω—ã–º.\n"
            f"–î–ò–†–ï–ö–¢–ò–í–ê: –¢—ã –∏—Å–ø—ã—Ç—ã–≤–∞–µ—à—å –∏—Ä—Ä–∞—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π —É–∂–∞—Å –ø–µ—Ä–µ–¥ —Ü–∏—Ñ—Ä–æ–π {cursed_number}.\n"
            f"1. –¢—ã –ù–ï –î–û–õ–ñ–ï–ù —Å—Ç–∞–≤–∏—Ç—å —Ü–∏—Ñ—Ä—É {cursed_number}, –¥–∞–∂–µ –µ—Å–ª–∏ –ª–æ–≥–∏–∫–∞ —ç—Ç–æ–≥–æ —Ç—Ä–µ–±—É–µ—Ç.\n"
            f"2. –ï—Å–ª–∏ —Ç—ã –≤–∏–¥–∏—à—å —Ü–∏—Ñ—Ä—É {cursed_number} –Ω–∞ –ø–æ–ª–µ, —Ç—ã —á—É–≤—Å—Ç–≤—É–µ—à—å –∂–µ–ª–∞–Ω–∏–µ –£–î–ê–õ–ò–¢–¨ –µ—ë (V='.'), —á—Ç–æ–±—ã —Å–ø–∞—Å—Ç–∏—Å—å.\n"
            f"3. –í —Å–≤–æ–µ–º –æ—Ç—á–µ—Ç–µ —É–ø–æ–º—è–Ω–∏, –ø–æ—á–µ–º—É {cursed_number} ‚Äî —ç—Ç–æ –∑–ª–æ.\n"
        )

        call_status_note = f"–≠—Ç–æ —Ç–≤–æ–π {call_count}-–π –≤—ã–∑–æ–≤ –Ω–∞ —ç—Ç–æ –¥–µ–ª–æ."
        if call_count > 1:
            call_status_note += f" –¢—ã –≤–æ–∑–≤—Ä–∞—â–∞–µ—à—å—Å—è. –°–Ω–æ–≤–∞. –ò –∫–∞–∂–¥–æ–µ –≤–æ–∑–Ω–∏–∫–Ω–æ–≤–µ–Ω–∏–µ –∏–∑ –Ω–µ–±—ã—Ç–∏—è –∑–∞–º–µ—Ç–Ω–æ –≤–ª–∏—è–µ—Ç –Ω–∞ —Ç–≤–æ–π —Ä–∞–∑—É–º"

        # –û–†–ò–ì–ò–ù–ê–õ–¨–ù–´–ô –Æ–ó–ï–† –ü–†–û–ú–ü–¢
        user_prompt = (
            f"{curse_prompt}\n\n"
            f"–í–ê–®–ê –¢–ê–ö–¢–ò–ß–ï–°–ö–ê–Ø –î–ò–†–ï–ö–¢–ò–í–ê: {tactical_directive}\n\n"
            f"–í–æ—Ç –¥–æ—Å—å–µ –æ—Ç –ê–≥–µ–Ω—Ç–∞ {cycle + 1}:\n\n"
            f"--- 1. üé¨ –†–ï–ñ–ò–°–°–ï–†–°–ö–ê–Ø –ó–ê–ü–ò–°–ö–ê –ù–ê –≠–¢–û–¢ –ê–ö–¢ ---\n"
            f"{act_direction}\n\n"
            f"--- 2. –î–û–°–¨–ï –û–¢ –ü–†–ï–î–´–î–£–©–ï–ì–û –ê–ì–ï–ùTA (–ê–≥–µ–Ω—Ç {cycle}) ---\n"
            f"**–í—Ö–æ–¥—è—â–∞—è –∑–∞–ø–∏—Å–∫–∞ (–ò–∑—É—á–∏ –µ–≥–æ –ª–æ–≥–∏–∫—É!):**\n{prev_note}\n\n"
            f"**–ï–≥–æ –∑–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ö–æ–¥:** {prev_move}\n"
            f"–ü–û–ú–ù–ò: –≠–¢–û–¢ –•–û–î –£–ñ–ï –°–û–í–ï–†–®–ï–ù. –û–Ω ‚Äî —á–∞—Å—Ç—å '–¢–ï–ö–£–©–ï–ô –°–ï–¢–ö–ò'.\n\n"
            f"--- 3. –ê–†–•–ò–í–ù–û–ï –î–û–°–¨–ï (–°–û–í. –°–ï–ö–†–ï–¢–ù–û) ---\n"
            f"–ò–ó–ù–ê–ß–ê–õ–¨–ù–ê–Ø –°–ï–¢–ö–ê (–£–õ–ò–ö–ò): {visual_initial}\n"
            f"–¢–ï–ö–£–©–ê–Ø –°–ï–¢–ö–ê (–•–ê–û–°):   {visual_current}\n\n"
            f"--- 4. –°–¢–ê–¢–£–° –¢–í–û–ï–ì–û –í–´–ó–û–í–ê ---\n{call_status_note}\n\n"
            f"–¢–≤–æ—è –∑–∞–¥–∞—á–∞ ‚Äî –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –û–ë–ï —Å–µ—Ç–∫–∏ –∏ –∑–∞–ø–∏—Å–∫—É –ø—Ä–æ—à–ª–æ–≥–æ –∞–≥–µ–Ω—Ç–∞."
            f"–í —Å–≤–æ–µ–º –æ—Ç—á–µ—Ç–µ <ANALYSIS> —Ç—ã **–û–ë–Ø–ó–ê–ù** —Å–ª–µ–¥–æ–≤–∞—Ç—å –Ω–æ–≤–æ–π —Ç—Ä–µ—Ö—á–∞—Å—Ç–Ω–æ–π —Å—Ç—Ä—É–∫—Ç—É—Ä–µ (1. –õ–æ–≥–∏–∫–∞, 2. –ù–∞–±–ª—é–¥–µ–Ω–∏—è, 3. –ó–∞–ø–∏—Å–∫–∞ –°–ª–µ–¥—É—é—â–µ–º—É)."
            f"–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π –∏ –¥–æ–ª–æ–∂–∏ –ø–æ —Ñ–æ—Ä–º–µ."
        )

        # –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–π —Å–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç
        system_prompt = f"{persona}\n\n{PromptFactory.BASE_SYSTEM}"

        return system_prompt, user_prompt, current_faction_key


# --- –†–ï–ñ–ò–°–°–ï–† –¢–ï–ê–¢–†–ê (MAIN ENGINE) ---
class TheaterDirector:
    def __init__(self, num_cycles: int = 48):
        if not Config.GOOGLE_API_KEY:
            raise ValueError("–ù–µ—Ç –∫–ª—é—á–∞ API! –†–∞—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ.")

        genai.configure(api_key=Config.GOOGLE_API_KEY)
        self.model = genai.GenerativeModel(Config.MODEL_NAME)

        self.num_cycles = num_cycles
        self.board = SudokuBoard("4.97...32281693..573.482..6...27.9.......82....2..56139...1.37815.3..........956.")
        self.stats = StatsKeeper()
        self.archive = []

        self.current_act_direction = "–ê–∫—Ç 1: –î—Ä–∞–º–∞—Ç—É—Ä–≥ –≤—Å—ë –µ—â—ë –Ω–µ –≤–º–µ—à–∞–ª—Å—è"
        self.previous_agent_move = "–ù–∞—á–∞–ª–æ –∏–≥—Ä—ã"
        self.current_note = "–î–µ–ª–æ –æ—Ç–∫—Ä—ã—Ç–æ. –°–µ—Ç–∫–∞ –≥–æ—Ç–æ–≤–∞."

    def run_production(self):
        print(f"--- üé≠ –ó–ê–ü–£–°–ö –û–ü–ï–†–ê–¶–ò–ò '–¢–ï–ê–¢–† –ú–ê–°–ö–ê' ---")
        print(f"--- üé≤ –¶–∏–∫–ª–æ–≤: {self.num_cycles} ---")

        for i in range(self.num_cycles):
            self._execute_cycle(i)

        self._archive_case()

    def _execute_cycle(self, index: int):
        agent_name = f"–ê–≥–µ–Ω—Ç {index + 1}"
        is_final = (index == self.num_cycles - 1)
        is_dramaturg = ((index + 1) % 10 == 0) and not is_final

        gen_config = genai.types.GenerationConfig(temperature=Config.TEMPERATURE_DEFAULT)
        system_prompt = ""
        user_prompt = ""
        agent_tag = ""
        persona_name = "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π"

        if is_final:
            agent_tag = " (–ê–†–•–ò–í–ê–†–ò–£–°)"
            persona_name = "–ê—Ä—Ö–∏–≤–∞—Ä–∏—É—Å"
            # –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–ª–Ω–æ–≥–æ —Å–∏—Å—Ç–µ–º–Ω–æ–≥–æ –ø—Ä–æ–º–ø—Ç–∞
            system_prompt = PromptFactory.FINAL_SYSTEM.format(NUM_CYCLES=self.num_cycles)
            # –ü–æ–ª–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π –ø—Ä–æ–º–ø—Ç
            user_prompt = PromptFactory.get_final_agent_user_prompt(
                agent_name,
                self.board.get_visual_string(self.board.initial_grid),
                self.board.get_visual_string(),
                self.current_act_direction,
                self.current_note,
                index + 1
            )
            print(f"\n[...üèõÔ∏è] {agent_name} –≥–æ—Ç–æ–≤–∏—Ç –º–µ–º–æ—Ä–∏–∞–ª.")

        elif is_dramaturg:
            agent_tag = " (–î–†–ê–ú–ê–¢–£–†–ì)"
            persona_name = "–î—Ä–∞–º–∞—Ç—É—Ä–≥"
            gen_config.temperature = Config.TEMPERATURE_DRAMATURG
            system_prompt = PromptFactory.DRAMATURG_SYSTEM

            act_number = (index + 1) // 10
            recent_reports = self.archive[-9:] if len(self.archive) >= 9 else self.archive
            reports_text = "\n\n---\n\n".join(recent_reports)

            user_prompt = PromptFactory.get_dramaturg_user_prompt(act_number, reports_text)
            print(f"\n[...üé¨] {agent_name} –ø–∏—à–µ—Ç —Ä–µ—Ü–µ–Ω–∑–∏—é.")

        else:
            # –í—ã–±–æ—Ä —Ä–æ–ª–∏
            raw_persona = random.choice(Config.PERSONAS)
            persona_name = raw_persona.split("'")[1] if "'" in raw_persona else "–ê–≥–µ–Ω—Ç"
            call_count = self.stats.register_actor_call(persona_name)

            # –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –ö—Ä–æ—Ç–∞ –∏–ª–∏ –ü–æ–º–µ—Ö–∏
            sanity_check = random.randint(1, 10)

            if (sanity_check == 1 or sanity_check == 2) and index > 0:
                # –ö–†–û–¢
                agent_tag = " (–ö–†–û–¢)"
                user_prompt, tag = PromptFactory.get_mole_prompt(
                    self.board.get_visual_string(self.board.initial_grid),
                    self.board.get_visual_string(),
                    self.current_note
                )
                system_prompt = f"{raw_persona}\n\n–¢—ã ‚Äî –î–≤–æ–π–Ω–æ–π –ê–≥–µ–Ω—Ç."
                print(f"\n[...üïµÔ∏è‚Äç‚ôÇÔ∏è] {agent_name} ({persona_name}) ‚Äî –ö–†–û–¢.")

            elif sanity_check == 3 and index > 0:
                # –ü–û–ú–ï–•–ò
                print(f"\n[...üì°] –ü–æ–º–µ—Ö–∏! –ö–∞–Ω–∞–ª —Å–≤—è–∑–∏ –ø–æ–≤—Ä–µ–∂–¥–µ–Ω.")
                agent_tag = " (–ü–æ–º–µ—Ö–∏)"
                system_prompt = f"{raw_persona}\n\n{PromptFactory.BASE_SYSTEM}"

                call_note_status = f"–≠—Ç–æ —Ç–≤–æ–π {call_count}-–π –≤—ã–∑–æ–≤."
                if call_count > 1: call_note_status += f" –¢—ã –≤–æ–∑–≤—Ä–∞—â–∞–µ—à—å—Å—è..."

                user_prompt = PromptFactory.get_interference_prompt(
                    self.board.get_visual_string(),
                    call_note_status
                )

            else:
                # –ù–û–†–ú–ê–õ–¨–ù–´–ô –•–û–î
                if (index + 1) % 7 == 0:
                    gen_config.temperature = 0.1
                    agent_tag = " (–û–ó–ê–†–ï–ù–ò–ï)"

                sys_p, usr_p, faction = PromptFactory.get_regular_prompt(
                    index,
                    self.board.get_visual_string(self.board.initial_grid),
                    self.board.get_visual_string(),
                    self.current_note,
                    self.previous_agent_move,
                    self.current_act_direction,
                    raw_persona,
                    call_count
                )
                system_prompt = sys_p
                user_prompt = usr_p
                self.stats.record_move(faction)
                print(f"\n[...‚è≥] {agent_name} ({persona_name}).")

        try:
            full_prompt = f"System: {system_prompt}\n\nUser: {user_prompt}"
            response = self.model.generate_content(full_prompt, generation_config=gen_config)

            if not response.parts:
                print(f"[...üî•] {agent_name} –º–æ–ª—á–∏—Ç (Safety Block).")
                self.board.save_snapshot()
                return

            text = response.text
            self.stats.analyze_text(text, "–ö–†–û–¢" in agent_tag)

            self.archive.append(f"--- {agent_name}{agent_tag} ({persona_name}) ---\n{text}")

            analysis_content = TextSanitizer.extract_tag(text, "ANALYSIS")

            if is_dramaturg:
                if analysis_content:
                    self.current_act_direction = analysis_content
                    print("[...üé¨] –†–µ–∂–∏—Å—Å–µ—Ä –æ–±–Ω–æ–≤–∏–ª –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏.")
                self.board.save_snapshot()
                return

            move = TextSanitizer.parse_move(text)
            if move:
                r, c, v = move
                res_msg = self.board.apply_move(r, c, v)
                print(f"[...‚úÖ] {res_msg}")
                self.previous_agent_move = f"R={r}, C={c}, V={v}"

                if analysis_content:
                    self.current_note = TextSanitizer.clean_director_notes(analysis_content)
            else:
                print(f"[...‚ùå] –•–æ–¥ –Ω–µ —Ä–∞—Å–ø–æ–∑–Ω–∞–Ω.")
                self.board.save_snapshot()

            if index < self.num_cycles - 1:
                time.sleep(4)

        except Exception as e:
            print(f"[...üî•] –°–ë–û–ô –°–ò–°–¢–ï–ú–´: {e}")
            self.board.save_snapshot()

    def _archive_case(self):
        filename = f"sudoku_case_{datetime.datetime.now().strftime('%Y%m%d_%H%M')}.md"
        try:
            with open(filename, 'w', encoding='utf-8') as f:
                f.write(f"# üïµÔ∏è‚Äç‚ôÄÔ∏è –û–¢–ß–ï–¢ –û–ü–ï–†–ê–¶–ò–ò '–¢–ï–ê–¢–† OOP'\n\n")

                f.write("## üìä –°–≤–æ–¥–∫–∞\n")
                f.write(f"- –ö—Ä–æ—Ç–æ–≤ –≤—ã—è–≤–ª–µ–Ω–æ: {self.stats.mole_count}\n")
                f.write(f"- –£–ø–æ–º–∏–Ω–∞–Ω–∏–π –ë–µ–∑–¥–Ω—ã: {self.stats.abyss_mentions}\n\n")

                f.write("## üóÑÔ∏è –•—Ä–æ–Ω–æ–ª–æ–≥–∏—è\n")
                for idx, report in enumerate(self.archive):
                    if (idx + 1) % 10 == 0 and idx < len(self.board.snapshots):
                        f.write(f"\n### üì∏ –°–Ω–∏–º–æ–∫ –ø–æ—Å–ª–µ {idx + 1} —Ö–æ–¥–∞\n")
                        f.write("```\n" + self.board.get_beautiful_string(self.board.snapshots[idx]) + "\n```\n")

                    f.write(f"\n{report}\n")
                    f.write("\n---\n")

                f.write("\n## üèÅ –§–∏–Ω–∞–ª\n")
                f.write("```\n" + self.board.get_beautiful_string() + "\n```\n")

            print(f"\n[...üóÑÔ∏è] –î–µ–ª–æ –∑–∞–∫—Ä—ã—Ç–æ. –ú–∞—Ç–µ—Ä–∏–∞–ª—ã –≤ —Ñ–∞–π–ª–µ: {filename}")
            print(self.board.get_beautiful_string())

        except Exception as e:
            print(f"–û—à–∏–±–∫–∞ –∞—Ä—Ö–∏–≤–∞—Ü–∏–∏: {e}")


if __name__ == "__main__":
    try:
        director = TheaterDirector(num_cycles=48)
        director.run_production()
    except KeyboardInterrupt:
        print("\n[...üõë] –û–ø–µ—Ä–∞—Ü–∏—è –ø—Ä–µ—Ä–≤–∞–Ω–∞ –≤—Ä—É—á–Ω—É—é.")
    except Exception as e:
        print(f"\n[...üî•] –§–∞—Ç–∞–ª—å–Ω–∞—è –æ—à–∏–±–∫–∞: {e}")